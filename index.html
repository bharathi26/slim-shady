<html lang="en"><head>
<meta charset="UTF-8">

<title>Slim Shady</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rete-stage0-render-plugin@0.2.14/build/stage0-render-plugin.debug.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/rete-stage0-menu-plugin@0.3.7/build/stage0-menu-plugin.debug.css">
<style>
html, body {
  height: 100%;
  height: 100%;
  margin: 0;
}

.node .control input, .node .input-control input {
  width: 140px;
}
select, input {
  width: 100%;
  border-radius: 30px;
  background-color: white;
  padding: 2px 6px;
  border: 1px solid #999;
  font-size: 110%;
  width: 170px;
}

svg.connection { // dirty fix, path coordinates are incorrect with default 1px for some reason
  width: 12px;
  height: 12px;
}
</style>
</head>
<body>
<div id="rete">

<script src="https://unpkg.com/stage0@0.0.15/dist/keyed.min.js"></script>
<script src="https://unpkg.com/stage0@0.0.15/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete@1.0.0-beta.5/build/rete.debug.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-stage0-render-plugin@0.2.14/build/stage0-render-plugin.debug.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-stage0-menu-plugin@0.3.7/build/stage0-menu-plugin.debug.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-connection-plugin@0.3.1/build/connection-plugin.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-area-plugin@0.1.5/build/area-plugin.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rete-comment-plugin@0.2.0/build/comment-plugin.min.js"></script>
<script id="rendered-js">
var numSocket = new Rete.Socket("Number value");

var Stage0NumControl = {
  template: '<input type="number"/>',
  data() {
    return {
      value: 0
    };
  },
  methods: {
    update() {
      if (this.root) {
        this.putData(this.ikey, +this.root.value);
      }

      this.emitter.trigger("process");
    }
  },
  mounted() {
    const _self = this;

    this.root.value = this.getData(this.ikey);

    this.root.onkeyup = function(e) {
      _self.root.update();
    };

    this.root.onmouseup = function(e) {
      _self.root.update();
    };

    this.root.ondblclick = function(e) {
      e.stopPropagation();
    };
  }
};

class NumControl extends Rete.Control {
  constructor(emitter, key, readonly) {
    super(key);
    this.component = Stage0NumControl;
    this.props = { emitter, ikey: key, readonly };
  }

  setValue(val) {
    this.stage0Context.root.value = val; // TODO get rid of stage0Context
  }
}

class NumComponent extends Rete.Component {
	constructor() {
		super("Number");
	}

	builder(node) {
		var out1 = new Rete.Output("num", "resultRGB", numSocket);
		return node.addControl(new NumControl(this.editor, "num")).addOutput(out1);
	}

	worker(node, inputs, outputs) {
		outputs["num"] = node.data.num;
	}
}

class Num1Component extends Rete.Component {
	constructor() {
		super("Number1");
	}

	builder(node) {
		var out1 = new Rete.Output("num", "resultRGB", numSocket);
		return node.addControl(new NumControl(this.editor, "num")).addOutput(out1);
	}

	worker(node, inputs, outputs) {
		outputs["num"] = node.data.num;
	}
}

class AddComponent extends Rete.Component {
	constructor() {
		super("PxrCurvature");
	}

	builder(node) {
		var inp1 = new Rete.Input("num1", "int numSamples", numSocket, true);
		var inp2 = new Rete.Input("num2", "maxDistance", numSocket, true);
		var out = new Rete.Output("num", "color vector normal point resultRGB", numSocket);
		var out1 = new Rete.Output("numl", "resultR", numSocket);

		inp1.addControl(new NumControl(this.editor, "num1"));
		inp2.addControl(new NumControl(this.editor, "num2"));

		return node
			.addInput(inp1)
			.addInput(inp2)
			.addControl(new NumControl(this.editor, "preview", true))
			.addOutput(out)
			.addOutput(out1);
	}

	worker(node, inputs, outputs) {
		var n1 = inputs["num1"].length ? inputs["num1"][0] : node.data.num1;
		var n2 = inputs["num2"].length ? inputs["num2"][0] : node.data.num2;
		var sum = n1 + n2;

		this.editor.nodes
			.find(n => n.id == node.id)
			.controls.get("preview")
			.setValue(sum);
		outputs["num"] = sum;
	}
}



class PxrPatternComponent extends Rete.Component {
	constructor() {
		super("PxrCurvature1");
	}

	builder(node) {
		var inp1 = new Rete.Input("num1", "int numSamples", numSocket, true);
		var inp2 = new Rete.Input("num2", "maxDistance", numSocket, true);
		var out = new Rete.Output("num", "color vector normal point resultRGB", numSocket);
		var out1 = new Rete.Output("numl", "resultR", numSocket);

		inp1.addControl(new NumControl(this.editor, "num1"));
		inp2.addControl(new NumControl(this.editor, "num2"));

		return node
			.addInput(inp1)
			.addInput(inp2)
			.addControl(new NumControl(this.editor, "preview", true))
			.addOutput(out)
			.addOutput(out1);
	}

	worker(node, inputs, outputs) {
		var n1 = inputs["num1"].length ? inputs["num1"][0] : node.data.num1;
		var n2 = inputs["num2"].length ? inputs["num2"][0] : node.data.num2;
		var sum = n1 + n2;

		this.editor.nodes
			.find(n => n.id == node.id)
			.controls.get("preview")
			.setValue(sum);
		outputs["num"] = sum;
	}
}



(async () => {
  var container = document.querySelector("#rete");
  var components = [new NumComponent(), new AddComponent(), new PxrPatternComponent()];

  var editor = new Rete.NodeEditor("demo@0.1.0", container);
  editor.use(ConnectionPlugin);
  editor.use(Stage0RenderPlugin);
  editor.use(Stage0MenuPlugin, {
    menuOptions: {
      delay: 100,
      allocate(component) {
        if (component.name == "Add") {
          return false;
        }
        return ["Menu", "Submenu"];
      },
      docked: true,
      items: {
        Menu: {
          "Add component": {
            Add: components[1]
          },
          Fn: () => {
            alert("Fn");
          }
        }
      }
    },
    dockedMenuOptions: {
      delay: 100,
      allocate(component) {
        return false;
      },
      docked: true,
      items: {
        Menu: {
          "Add component": {
            Add: components[1]
          },
          "Add component 2": {
            X: components[1]
          }
        }
      }
    }
  });
  editor.use(AreaPlugin);
  editor.use(CommentPlugin);

  var engine = new Rete.Engine("demo@0.1.0");

  components.map(c => {
    editor.register(c);
    engine.register(c);
  });

  var n1 = await components[0].createNode({ num: 17 });
  var n2 = await components[0].createNode({ num: 0 });
  var add = await components[1].createNode();

  n1.data["collapsed"] = true;

  n1.position = [80, 200];
  n2.position = [80, 400];
  add.position = [500, 240];

  editor.addNode(n1);
  editor.addNode(n2);
  editor.addNode(add);

  editor.connect(n1.outputs.get("num"), add.inputs.get("num1"));
  editor.connect(n2.outputs.get("num"), add.inputs.get("num2"));

  editor.on(
    "process nodecreated noderemoved connectioncreated connectionremoved",
    async () => {
      console.log("process");
      await engine.abort();
      await engine.process(editor.toJSON());
    }
  );

  editor.view.resize();
  AreaPlugin.zoomAt(editor);
  editor.trigger("process");
})();
</script>

</body></html>
